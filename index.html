<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fucxia Tags V3.4 - QR Deep Link</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --fucxia: #EF157C; --black: #000000; --red: #d32f2f; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; color: #333; }
        .container { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); width: 95%; max-width: 600px; margin-bottom: 20px; box-sizing: border-box; }
        .app-logo-container { text-align: center; margin-bottom: 15px; position: relative; padding-top: 15px; }
        #appLogoImg { max-height: 80px; display: none; margin: 0 auto 10px; border-radius: 8px; max-width: 100%; }
        .btn-del-circle { background: var(--red); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; position: absolute; display: none; z-index: 50; font-weight: bold; line-height: 24px; text-align: center; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #delAppMain { top: 0; right: 0; }
        .logo-section { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .upload-box { border: 2px dashed #ccc; padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; position: relative; min-height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .upload-box label { font-size: 10px; font-weight: bold; color: var(--fucxia); cursor: pointer; }
        .small-preview { max-height: 40px; margin-top: 5px; display: none; border-radius: 4px; }
        .dimensions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #fff0f6; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .input-group { margin-bottom: 15px; position: relative; width: 100%; }
        label.field-title { display: block; font-weight: bold; font-size: 12px; margin-bottom: 5px; color: #555; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        textarea#destino { resize: vertical; min-height: 80px; text-transform: uppercase; }
        .btn-main { background: var(--fucxia); color: white; border: none; padding: 18px; border-radius: 10px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-shalom { background: var(--red); color: white; border: none; padding: 12px; border-radius: 6px; width: 100%; margin-top: 8px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .history-section { width: 95%; max-width: 1100px; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 40px; }
        .table-container { overflow-x: auto; width: 100%; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 900px; }
        .history-table th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #eee; color: #666; text-transform: uppercase; }
        .history-table td { padding: 12px; border-bottom: 1px solid #f1f1f1; vertical-align: middle; }
        .suggestion-box { position: absolute; background: white; border: 1px solid #ddd; width: 100%; z-index: 100; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px; }
        .action-btns { display: flex; gap: 8px; }
        .btn-load { background: var(--fucxia); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 10px; }
        .btn-delete-reg { background: #eee; color: #666; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 10px; }
        .hidden { display: none !important; }
        #qr-buffer { position: absolute; left: -9999px; top: -9999px; }
    </style>
</head>
<body>

<div id="qr-buffer"></div>

<div class="container">
    <div class="app-logo-container">
        <button class="btn-del-circle" id="delAppMain" onclick="deleteImg('app')">‚úï</button>
        <img id="appLogoImg">
        <div id="appUploadBox" class="upload-box">
            <label for="inApp">üìÅ SUBIR LOGO APP</label>
            <input type="file" id="inApp" accept="image/*" class="hidden">
        </div>
        <h2 style="margin: 5px 0; color: var(--fucxia); font-size: 22px;">Fucxia Tags V3.4</h2>
    </div>

    <div class="logo-section">
        <div class="upload-box">
            <button class="btn-del-circle" id="delTagBtn" style="top:-8px; right:-8px;" onclick="deleteImg('tag')">‚úï</button>
            <label for="inTag">üìÅ LOGO ETIQUETA</label>
            <input type="file" id="inTag" accept="image/*" class="hidden">
            <img id="prevTag" class="small-preview">
        </div>
        <div class="upload-box">
            <button class="btn-del-circle" id="delWmkBtn" style="top:-8px; right:-8px;" onclick="deleteImg('wmk')">‚úï</button>
            <label for="inWmk">üìÅ MARCA AGUA</label>
            <input type="file" id="inWmk" accept="image/*" class="hidden">
            <img id="prevWmk" class="small-preview">
        </div>
    </div>

    <div class="dimensions">
        <div><label class="field-title">Altura (cm)</label><input type="number" id="hCm" value="10" step="0.1"></div>
        <div><label class="field-title">Largo (cm)</label><input type="number" id="wCm" value="15" step="0.1"></div>
    </div>

    <div class="input-group">
        <label class="field-title">Remitente</label>
        <select id="remitente">
            <option value="INGRID FLORES DEL AGUILA">Ingrid Flores Del Aguila</option>
            <option value="ANGEL DIAZ">Angel Diaz</option>
            <option value="GLADYS FLORES">Gladys Flores</option>
        </select>
    </div>

    <div class="input-group">
        <label class="field-title">Nombre del Cliente</label>
        <input type="text" id="cliente" placeholder="Nombre completo" autocomplete="off" oninput="this.value = this.value.toUpperCase(); searchByField('nombre', 'cliente', 'suggestionsName')">
        <div id="suggestionsName" class="suggestion-box"></div>
    </div>
    
    <div class="dimensions" style="padding:0; background:none;">
        <div class="input-group">
            <label class="field-title">DNI</label>
            <input type="text" id="dni" placeholder="12345678" autocomplete="off" oninput="searchByField('dni', 'dni', 'suggestionsDni')">
            <div id="suggestionsDni" class="suggestion-box"></div>
        </div>
        <div class="input-group">
            <label class="field-title">Tel√©fono</label>
            <input type="text" id="cel" placeholder="999 999 999">
        </div>
    </div>

    <div class="input-group">
        <label class="field-title">Empresa de Env√≠o</label>
        <select id="courier" onchange="toggleCourier()">
            <option value="SHALOM">Shalom</option>
            <option value="OTROS">Otros</option>
        </select>
        <div id="shalomActionBox"><button class="btn-shalom" onclick="window.open('https://agencias.shalom.pe/', '_blank')">üîç BUSCAR AGENCIA SHALOM</button></div>
        <div id="boxOthers" class="hidden" style="background: #f0f7ff; padding: 10px; border-radius: 8px; margin-top: 10px;">
            <label class="field-title">Agencia:</label><input type="text" id="manualCourier" placeholder="Nombre de la agencia" oninput="this.value = this.value.toUpperCase()">
        </div>
    </div>

    <div class="input-group">
        <label class="field-title">Destino</label>
        <textarea id="destino" placeholder="Direcci√≥n de Oficina / Agencia" oninput="this.value = this.value.toUpperCase()"></textarea>
    </div>

    <input type="hidden" id="notionFullUrl"> <button class="btn-main" onclick="processTag()">GENERAR ETIQUETA</button>
</div>

<div class="history-section">
    <h3 style="margin: 0 0 15px 0; font-size: 18px; color: var(--fucxia);">üìÅ Directorio e historial</h3>
    <div class="table-container">
        <table class="history-table">
            <thead>
                <tr>
                    <th>Fecha / Hora</th>
                    <th>Nombre</th>
                    <th>DNI</th>
                    <th>Tel√©fono</th>
                    <th>Empresa</th>
                    <th>Direcci√≥n</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>
</div>

<script>
    let imgs = { app: localStorage.getItem('app')||"", tag: localStorage.getItem('tag')||"", wmk: localStorage.getItem('wmk')||"" };
    let directory = JSON.parse(localStorage.getItem('directory') || "[]");
    let wmkRatio = 0.56;

    window.onload = () => { updateUI(); renderHistory(); calculateWmkRatio(); toggleCourier(); checkURLParams(); };

    function checkURLParams() {
        const params = new URLSearchParams(window.location.search);
        if (params.has('nombre')) {
            document.getElementById('cliente').value = decodeURIComponent(params.get('nombre')).toUpperCase();
            document.getElementById('dni').value = params.get('dni') || "";
            document.getElementById('cel').value = params.get('cel') || "";
            document.getElementById('destino').value = decodeURIComponent(params.get('destino') || "").toUpperCase();
            document.getElementById('hCm').value = params.get('h') || "10";
            document.getElementById('wCm').value = params.get('w') || "15";
            // Aqu√≠ capturamos la URL completa que viene de Notion
            document.getElementById('notionFullUrl').value = params.get('notion') || "";
            
            if (params.has('courier')) {
                const cVal = decodeURIComponent(params.get('courier')).toUpperCase();
                const sel = document.getElementById('courier');
                if (cVal === 'SHALOM') { sel.value = 'SHALOM'; } 
                else { sel.value = 'OTROS'; document.getElementById('manualCourier').value = cVal; }
                toggleCourier();
            }
        }
    }

    function calculateWmkRatio() { if(imgs.wmk) { let img = new Image(); img.src = imgs.wmk; img.onload = function() { wmkRatio = this.height / this.width; } } }

    function updateUI() {
        const appImg = document.getElementById('appLogoImg');
        const appBox = document.getElementById('appUploadBox');
        const delApp = document.getElementById('delAppMain');
        if(imgs.app) { appImg.src = imgs.app; appImg.style.display = 'block'; appBox.classList.add('hidden'); delApp.style.display = 'block'; }
        else { appImg.style.display = 'none'; appBox.classList.remove('hidden'); delApp.style.display = 'none'; }
        ['tag', 'wmk'].forEach(k => {
            const prev = document.getElementById('prev' + k.charAt(0).toUpperCase() + k.slice(1));
            const btn = document.getElementById('del' + k.charAt(0).toUpperCase() + k.slice(1) + 'Btn');
            if(imgs[k]) { prev.src = imgs[k]; prev.style.display = 'block'; btn.style.display = 'block'; }
            else { prev.style.display = 'none'; btn.style.display = 'none'; }
        });
    }

    function deleteImg(k) { imgs[k] = ""; localStorage.removeItem(k); updateUI(); }

    ['inApp','inTag','inWmk'].forEach(id => {
        document.getElementById(id).onchange = (e) => {
            const reader = new FileReader(); const k = id.replace('in','').toLowerCase();
            reader.onload = () => { imgs[k] = reader.result; localStorage.setItem(k, reader.result); updateUI(); if(k==='wmk') calculateWmkRatio(); };
            reader.readAsDataURL(e.target.files[0]);
        };
    });

    function toggleCourier() {
        const isShalom = document.getElementById('courier').value === 'SHALOM';
        document.getElementById('shalomActionBox').classList.toggle('hidden', !isShalom);
        document.getElementById('boxOthers').classList.toggle('hidden', isShalom);
    }

    function searchByField(dataKey, inputId, suggestionBoxId) {
        const val = document.getElementById(inputId).value.toUpperCase();
        const box = document.getElementById(suggestionBoxId);
        box.innerHTML = "";
        if(val.length < 2) { box.style.display = 'none'; return; }
        const matches = directory.filter(c => c[dataKey].toString().toUpperCase().includes(val));
        if(matches.length > 0) {
            box.style.display = 'block';
            matches.forEach(m => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `<strong>${m.nombre}</strong><br><small>DNI: ${m.dni}</small>`;
                div.onclick = () => fillData(m);
                box.appendChild(div);
            });
        } else { box.style.display = 'none'; }
    }

    function fillData(m) {
        document.getElementById('cliente').value = m.nombre;
        document.getElementById('dni').value = m.dni;
        document.getElementById('cel').value = m.cel;
        document.getElementById('destino').value = m.destino;
        document.getElementById('notionFullUrl').value = m.notion || "";
        document.getElementById('hCm').value = m.h || "10";
        document.getElementById('wCm').value = m.w || "15";
        if(m.courier) {
            document.getElementById('courier').value = m.courier;
            if(m.courier === 'OTROS') document.getElementById('manualCourier').value = m.manual || "";
            toggleCourier();
        }
        document.querySelectorAll('.suggestion-box').forEach(b => b.style.display = 'none');
    }

    function renderHistory() {
        const body = document.getElementById('historyBody');
        body.innerHTML = "";
        const sorted = [...directory].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        sorted.forEach((t) => {
            const dObj = new Date(t.fecha);
            const dS = dObj.toLocaleDateString('es-PE', { day:'2-digit', month:'2-digit', year:'numeric' });
            const tS = dObj.toLocaleTimeString('es-PE', { hour:'2-digit', minute:'2-digit', hour12: true }).toUpperCase();
            const eS = t.courier === 'OTROS' ? t.manual : 'SHALOM';
            body.innerHTML += `<tr>
                <td style="color:#666">${dS}<br>${tS}</td>
                <td><strong>${t.nombre}</strong></td>
                <td>${t.dni}</td>
                <td>${t.cel}</td>
                <td style="color:var(--fucxia); font-weight:bold;">${eS}</td>
                <td style="white-space: pre-wrap;">${t.destino}</td>
                <td><div class="action-btns">
                    <button class="btn-load" onclick='fillData(${JSON.stringify(t)})'>CARGAR</button>
                    <button class="btn-delete-reg" onclick='deleteRecord("${t.dni}", "${t.nombre}")'>ELIMINAR</button>
                </div></td>
            </tr>`;
        });
    }

    function deleteRecord(dni, nombre) {
        if(confirm(`¬øEliminar registro de ${nombre}?`)) {
            directory = directory.filter(c => (c.dni !== dni || dni === "") && (c.nombre !== nombre || dni !== ""));
            localStorage.setItem('directory', JSON.stringify(directory));
            renderHistory();
        }
    }

    async function processTag() {
        const data = {
            nombre: document.getElementById('cliente').value.toUpperCase(),
            dni: document.getElementById('dni').value,
            cel: document.getElementById('cel').value,
            destino: document.getElementById('destino').value.toUpperCase(),
            h: document.getElementById('hCm').value,
            w: document.getElementById('wCm').value,
            notion: document.getElementById('notionFullUrl').value,
            courier: document.getElementById('courier').value,
            manual: (document.getElementById('courier').value === 'OTROS') ? document.getElementById('manualCourier').value.toUpperCase() : "SHALOM",
            fecha: new Date().toISOString()
        };
        if(!data.nombre || !data.destino) return alert("Faltan datos.");
        const exIdx = directory.findIndex(c => (c.dni === data.dni && data.dni !== "") || (c.nombre === data.nombre && data.dni === ""));
        if(exIdx !== -1) { directory[exIdx] = data; } else { directory.push(data); }
        localStorage.setItem('directory', JSON.stringify(directory));
        renderHistory();
        await generatePDF(data);
    }

    async function generatePDF(data) {
        const { jsPDF } = window.jspdf;
        const hm = parseFloat(data.h) * 10, wm = parseFloat(data.w) * 10;
        let orient = (wm > 210) ? 'l' : 'p';
        const doc = new jsPDF(orient, 'mm', 'a4');
        const pW = (orient === 'p') ? 210 : 297;
        const xPos = (pW - wm) / 2;

        let qrImg = null;
        if(data.notion) {
            const buffer = document.getElementById("qr-buffer");
            buffer.innerHTML = "";
            // Genera el QR usando la URL completa enviada desde Notion
            new QRCode(buffer, { text: data.notion, width: 200, height: 200, correctLevel: QRCode.CorrectLevel.H });
            await new Promise(r => setTimeout(r, 150));
            const canvas = buffer.querySelector("canvas");
            if(canvas) qrImg = canvas.toDataURL("image/png");
        }

        drawTag(doc, xPos, 10, wm, hm, data, qrImg);
        doc.addPage();
        drawTag(doc, xPos, 10, wm, hm, data, qrImg);
        doc.save(`Fucxia_${data.nombre}.pdf`);
    }

    function drawTag(doc, x, y, w, h, data, qrImg) {
        doc.setLineWidth(0.26); doc.setDrawColor(0); doc.rect(x, y, w, h);
        const margin = 5; const usableW = w - (margin * 2); 
        const logoSize = Math.min(h * 0.20, 30);
        
        if(imgs.tag) doc.addImage(imgs.tag, 'PNG', x + margin, y + 2, logoSize, logoSize);
        
        // QR 2x2 cm en esquina inferior derecha
        if(qrImg) {
            doc.addImage(qrImg, 'PNG', x + w - 22, y + h - 22, 20, 20);
        }

        const lineY = y + logoSize + 4;
        doc.setDrawColor(239, 21, 124); doc.setLineWidth(0.7); doc.line(x, lineY, x + w, lineY);
        
        if(imgs.wmk) {
            doc.setGState(new doc.GState({opacity: 0.1}));
            const long = Math.max(w, h); const wmkW = long * 0.4; const wmkH = wmkW * wmkRatio;
            doc.addImage(imgs.wmk, 'PNG', x + w/2 - wmkW/2, y + h/2 - wmkH/2, wmkW, wmkH);
        }
        
        doc.setGState(new doc.GState({opacity: 1}));
        const startY = lineY + 2;
        const lines = [{l: "PARA: ", c: data.nombre}, {l: "DNI: ", c: data.dni}, {l: "CEL: ", c: data.cel}, {l: "DESTINO: ", c: data.destino}];
        
        let fontSize = 60;
        while(fontSize > 6) {
            doc.setFontSize(fontSize);
            let checkY = startY + (fontSize * 0.7);
            let fits = true;
            for(let line of lines) {
                const sl = doc.splitTextToSize(line.l + line.c, usableW);
                checkY += (sl.length * fontSize * 0.45);
                if(checkY > (y + h - 5)) { fits = false; break; }
            }
            if(fits) break;
            fontSize -= 1;
        }

        doc.setTextColor(239, 21, 124); doc.setFontSize(14); doc.setFont("helvetica", "bold");
        doc.text("DE: " + document.getElementById('remitente').value, x + margin + logoSize + 5, y + (logoSize/2) + 2);

        let curY = startY + (fontSize * 0.7);
        lines.forEach(obj => {
            doc.setFontSize(fontSize); doc.setTextColor(239, 21, 124); doc.setFont("helvetica", "bold");
            const lw = doc.getTextWidth(obj.l);
            doc.text(obj.l, x + margin, curY);
            doc.setTextColor(0); doc.setFont("helvetica", (obj.l.includes("PARA"))?"bold":"normal");
            // Si hay QR, acortamos el ancho disponible para el texto de destino al llegar al final
            const split = doc.splitTextToSize(obj.c, (obj.l.includes("DESTINO") && qrImg) ? usableW - 25 : usableW - lw);
            split.forEach((t, i) => { doc.text(t, (i === 0) ? (x + margin + lw) : (x + margin), curY); curY += fontSize * 0.45; });
        });
    }
</script>
</body>
</html>
